# 2025-08-08 地下水位预测项目代码总结文档

## 项目概述

本项目是一个地下水位时序预测的综合性机器学习/深度学习框架，实现了统计学、机器学习和深度学习三大类预测方法的对比分析。项目名称为 `Groundwater_Level_Prediction_ML_DL`，旨在为地下水位预测提供可复现的跨范式基准测试平台。

## 项目结构

```
├── database/                           # 数据文件夹
│   ├── plots/                          # 数据清洗后的可视化图表
│   ├── individual_wells/               # 单井位数据文件
│   ├── ZoupingCounty_gwl_data*.xlsx    # 邹平县地下水位原始数据
│   ├── ZoupingCounty_gwl_filled.xlsx   # 最终清洗插值后的数据
│   └── 长序列的两口井先不测试.xlsx      # 长序列数据（暂不使用）
├── model/                              # 深度学习模型定义
│   ├── model.py                        # GRU、LSTM、Transformer模型实现
│   └── __pycache__/                    # Python缓存文件
├── results/                            # 训练和预测结果输出目录
│   ├── multi_wells_transformer/        # 多井位Transformer结果
│   ├── multi_wells_gru/                # 多井位GRU结果
│   ├── multi_wells_lstm/               # 多井位LSTM结果
│   ├── multi_wells_ml/                 # 多井位机器学习结果
│   ├── multi_wells_arima/              # 多井位ARIMA结果
│   ├── single_well_transformer/        # 单井位Transformer结果
│   ├── single_well_arima/              # 单井位ARIMA结果
│   ├── single_well_arima_inference/    # 单井位ARIMA预测结果
│   ├── single_well_inference_transformer/ # 单井位Transformer预测结果
│   ├── arima_inference/                # ARIMA模型预测结果
│   └── ml_inference/                   # 机器学习模型预测结果
├── DataCleaning.py                     # 数据清洗脚本
├── process_gwl_data.py                 # 数据处理脚本
├── train_3DL_multi_wells.py           # 多井位深度学习训练（并行）
├── train_3DL_single_well.py           # 单井位深度学习训练
├── train_arima_multi_wells.py         # 多井位ARIMA训练（并行）
├── train_arima_single_well.py         # 单井位ARIMA训练
├── train_ml_multi_wells.py            # 多井位机器学习训练（并行）
├── train_ml_single_well.py            # 单井位机器学习训练
├── predict_3DL_single_well_inference.py # 单井位深度学习预测脚本
├── predict_arima_single_well.py       # 单井位ARIMA预测脚本
├── predict_arima_multi_wells.py       # 多井位ARIMA预测脚本
├── predict_ml_multi_wells.py          # 多井位机器学习预测脚本
├── run_all_wells_*.sh                 # 批量训练脚本
├── requirements.txt                    # 依赖包列表
└── README.md                          # 项目说明文档
```

## 核心功能模块

### 1. 数据处理模块

#### 1.1 数据清洗 (`DataCleaning.py`)
**功能**：
- 读取原始Excel地下水位数据
- 自动生成井位列名（格式：`<中文名称>-井<n>`）
- 日期解析和数据清洗（支持两种时间格式）
- 截取有效时间区间（至2019-10-01）
- 线性/样条插值填补缺失值
- 生成双子图对比（原始vs处理后）

#### 1.2 数据处理 (`process_gwl_data.py`)
**功能**：
- 高级数据预处理管道
- 支持多种插值方法
- 数据质量检查和异常值处理

### 2. 统计学方法（ARIMA建模）

#### 2.1 单井位ARIMA (`train_arima_single_well.py`)
**核心特点**：
- **自动差分**：通过ADF检验和Ljung-Box检验自动确定差分阶数
- **网格搜索**：AIC准则驱动的(p,q)参数优化
- **模型保存**：使用pickle保存训练好的ARIMA模型
- **详细日志**：完整的建模过程记录
- **结果保存**：JSON格式详细结果 + Excel汇总表

#### 2.2 多井位ARIMA (`train_arima_multi_wells.py`)
**并行处理特性**：
- **ProcessPoolExecutor**：多进程并行建模
- **模型保存**：自动保存每个井位的ARIMA模型文件
- **错误处理**：单井位失败不影响整体流程
- **批量可视化**：自动生成概览图和单井位详细图
- **灵活展示**：支持指定井位序号生成图表

#### 2.3 ARIMA预测脚本
- **单井位预测** (`predict_arima_single_well.py`)：加载单个ARIMA模型进行预测
- **多井位预测** (`predict_arima_multi_wells.py`)：批量加载多个ARIMA模型进行预测

### 3. 机器学习方法（梯度提升树）

#### 3.1 单井位机器学习 (`train_ml_single_well.py`)
**支持的算法**：
- **XGBoost**：梯度提升决策树
- **LightGBM**：轻量级梯度提升机

#### 3.2 多井位机器学习 (`train_ml_multi_wells.py`)
**并行处理架构**：
- 每个井位 × 每个模型的任务并行化
- 统一的结果收集和汇总
- 自动模型保存（joblib格式）

#### 3.3 机器学习预测脚本 (`predict_ml_multi_wells.py`)
**功能特点**：
- 自动搜索并加载已保存的机器学习模型
- 支持XGBoost和LightGBM模型的预测
- 生成预测对比图和Excel结果文件

### 4. 深度学习方法（神经网络）

#### 4.1 单井位深度学习 (`train_3DL_single_well.py`)
**支持的架构**：
- **GRU**：门控循环单元，轻量级门控机制
- **LSTM**：长短期记忆网络，显式细胞状态
- **Transformer**：自注意力编码器，全局上下文建模

#### 4.2 多井位深度学习 (`train_3DL_multi_wells.py`)
**重要更新**：
- **分模型目录保存**：结果保存在`multi_wells_{model_type}`文件夹下
- **高级并行处理**：支持选择性模型训练（--models参数）
- **灵活的可视化控制**：--show_wells参数
- **完整的训练状态监控和错误处理**

#### 4.3 深度学习预测脚本 (`predict_3DL_single_well_inference.py`)
**重要更新**：
- **规范化命名**：结果保存在`single_well_inference_{model_type}`目录
- **文件命名优化**：Excel文件命名为`single_well_inference_{model_type}_{well_name}.xlsx`
- **完整的预测流程**：模型加载、预测、可视化、结果保存

### 5. 模型定义模块 (`model/model.py`)

**架构实现**：
- **GeneratorGRU**：简洁的GRU实现，包含Dropout正则化
- **GeneratorLSTM**：增强的LSTM，集成深度可分离卷积
- **GeneratorTransformer**：完整的Transformer编码器，支持因果掩码

## 最新功能更新（2025-08-08）

### 1. 完善的预测脚本体系

#### 1.1 ARIMA预测脚本完善
- **模型保存功能**：修改了训练脚本，添加了pickle模型保存功能
- **单井位预测**：`predict_arima_single_well.py` - 简洁易懂的单井位预测
- **多井位预测**：`predict_arima_multi_wells.py` - 批量预测多个井位
- **统一的结果格式**：预测值和真实值保存在Excel的不同列中

#### 1.2 机器学习预测脚本
- **多井位预测**：`predict_ml_multi_wells.py` - 支持XGBoost和LightGBM模型
- **自动模型发现**：自动搜索并加载已保存的模型文件
- **避免重复处理**：优化了模型加载逻辑，避免重复井位

#### 1.3 深度学习预测脚本优化
- **规范化命名**：`predict_3DL_single_well_inference.py` 使用统一的命名规范
- **结果目录优化**：保存在`single_well_inference_{model_type}`目录下

### 2. 训练脚本优化

#### 2.1 多井位深度学习训练优化
- **分模型保存**：`train_3DL_multi_wells.py` 现在将每个模型类型的结果保存在独立的`multi_wells_{model_type}`文件夹下
- **更好的组织结构**：每个模型类型有独立的JSON结果、Excel汇总和可视化图表

#### 2.2 ARIMA训练脚本增强
- **模型持久化**：添加了pickle模型保存功能
- **完整的预测流程支持**：保存的模型可以直接用于预测脚本

### 3. 结果文件组织优化

#### 3.1 新的目录结构
```
results/
├── multi_wells_transformer/           # Transformer多井位结果
├── multi_wells_gru/                   # GRU多井位结果  
├── multi_wells_lstm/                  # LSTM多井位结果
├── multi_wells_ml/                    # 机器学习多井位结果
├── multi_wells_arima/                 # ARIMA多井位结果
├── single_well_arima/                 # 单井位ARIMA结果
├── single_well_inference_transformer/ # Transformer单井位预测
├── single_well_arima_inference/       # ARIMA单井位预测
├── arima_inference/                   # ARIMA批量预测结果
└── ml_inference/                      # 机器学习预测结果
```

#### 3.2 统一的文件命名规范
- **训练结果**：`{method}_results_{well}.json`, `{method}_summary.xlsx`
- **预测结果**：`single_well_inference_{model_type}_{well}.xlsx`
- **可视化图表**：`pred_vs_true_{model}_{well}.png`, `prediction_{model}_{well}.png`

## 技术亮点

### 1. 完整的模型生命周期管理
- **训练阶段**：自动保存模型权重和配置
- **预测阶段**：加载保存的模型进行推理
- **结果管理**：统一的结果格式和可视化

### 2. 灵活的预测脚本设计
- **简洁易懂**：代码结构清晰，分为明确的步骤
- **参数化配置**：支持命令行参数自定义
- **错误处理**：完善的异常处理和用户提示

### 3. 统一的评估体系
- **一致的指标**：所有方法使用相同的RMSE、MAE、MAPE指标
- **标准化可视化**：统一的图表风格和布局
- **Excel结果导出**：便于后续分析和报告

### 4. 工程化的代码质量
- **模块化设计**：功能清晰分离，便于维护
- **详细的日志输出**：实时显示处理进展
- **完善的文档**：代码注释和使用说明

## 使用示例

### 1. 完整的建模和预测流程

#### ARIMA方法
```bash
# 1. 训练单井位ARIMA模型
python train_arima_single_well.py --well_col 2

# 2. 使用训练好的模型进行预测
python predict_arima_single_well.py --well_col 2

# 3. 训练多井位ARIMA模型
python train_arima_multi_wells.py --start_col 2 --end_col 4

# 4. 批量预测多个井位
python predict_arima_multi_wells.py
```

#### 机器学习方法
```bash
# 1. 训练多井位机器学习模型
python train_ml_multi_wells.py --start_col 2 --end_col 4

# 2. 使用训练好的模型进行预测
python predict_ml_multi_wells.py
```

#### 深度学习方法
```bash
# 1. 训练多井位深度学习模型（分模型保存）
python train_3DL_multi_wells.py --start_col 2 --end_col 4 --models transformer

# 2. 单井位深度学习预测（规范化命名）
python predict_3DL_single_well_inference.py
```

### 2. 高级功能使用

#### 并行处理
```bash
# 使用4个进程并行训练
python train_arima_multi_wells.py --parallel --n_jobs 4 --start_col 2 --end_col 6
```

#### 选择性可视化
```bash
# 只为指定井位生成图表
python train_3DL_multi_wells.py --show_wells "2,4,6" --models transformer
```

## 项目优势

### 1. 方法论完整性
- **三大范式覆盖**：统计学（ARIMA）、机器学习（XGBoost/LightGBM）、深度学习（GRU/LSTM/Transformer）
- **统一评估标准**：所有方法使用相同的评估指标和可视化格式
- **完整的预测流程**：从训练到预测的完整工作流

### 2. 工程化水平
- **模型持久化**：所有训练好的模型都可以保存和重用
- **批量处理能力**：支持多井位并行训练和预测
- **结果标准化**：统一的文件命名和目录结构

### 3. 用户友好性
- **简洁的接口**：清晰的命令行参数和使用说明
- **详细的输出**：实时进度显示和结果汇总
- **完善的错误处理**：友好的错误提示和异常处理

### 4. 扩展性设计
- **模块化架构**：便于添加新的模型和方法
- **参数化配置**：灵活的超参数调整
- **标准化接口**：统一的数据处理和结果输出格式

## 技术栈

**核心依赖**：
```
torch>=2.0          # 深度学习框架
pandas              # 数据处理
numpy               # 数值计算
scikit-learn        # 机器学习工具
matplotlib          # 可视化
xgboost>=1.7        # 梯度提升
lightgbm>=4.0       # 轻量级GBDT
statsmodels         # 统计建模
openpyxl            # Excel读写
joblib              # 模型序列化
pickle              # Python对象序列化
```

## 应用场景

**适用领域**：
- 地下水资源管理和预测
- 水文时序数据分析
- 环境监测数据建模
- 时序预测方法对比研究
- 机器学习教学和研究

**扩展方向**：
- 多变量输入（降水、抽水量等外部因子）
- 概率预测（分位数回归、不确定性量化）
- 实时预测系统
- Web界面和API服务

## 开发历程

### 主要里程碑
- **2025-07-08**：时序预测建模框架搭建
- **2025-07-09**：批量训练脚本开发
- **2025-07-21**：项目架构完善和文档编写
- **2025-08-08**：预测脚本体系完善，模型保存功能增强

### 最新更新（2025-08-08）
1. **ARIMA模型保存功能**：修改训练脚本，添加pickle模型保存
2. **完整的预测脚本**：为所有方法创建了对应的预测脚本
3. **结果目录优化**：深度学习结果按模型类型分目录保存
4. **文件命名规范化**：统一的命名规范，便于结果管理
5. **代码质量提升**：增强错误处理和用户体验

---

*本文档总结了地下水位预测项目的最新技术架构和实现细节，反映了2025年8月8日的项目状态和功能更新。*